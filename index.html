<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="light dark">
<title>‚òÄÔ∏è Sun Clock Pro ‚Äî Minimal</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<!-- iOS PWA support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sun Clock Pro">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#0f172a; --panel:#111827; --card:#0b1220;
  --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --btn-pri-bg:#14532d; --btn-pri-fg:#ffffff; --btn-pri-bd:#14532d;
  --btn-sec-bg:#1e293b; --btn-sec-fg:#ffffff; --btn-sec-bd:#1e293b;
  --btn-act-bg:#0b1220; --btn-act-fg:#e5e7eb; --btn-act-bd:#1f2937;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
header{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 16px;position:sticky;top:0;z-index:10}
h1{margin:0;font-size:16px;font-weight:600}
.page{max-width:1280px;margin:0 auto;padding:16px}
.section{border:1px solid var(--border);background:var(--panel);border-radius:12px;margin-bottom:12px}
.section>h2{margin:0;padding:10px 14px;border-bottom:1px solid var(--border);font-size:14px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 1fr 360px;gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;min-height:260px}
.row{display:flex;align-items:center;gap:8px;margin:10px 0}
.hr{height:1px;background:var(--border);margin:12px 0}
.big{font-size:40px;font-weight:800;letter-spacing:.5px}
.small{font-size:12px;color:var(--muted)}
.label{font-size:13px;color:var(--muted);margin-bottom:6px}
.kv{margin:8px 0}
input,select,button{height:38px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
input::placeholder{color:var(--muted)}
input:focus,select:focus,button:focus{outline:2px solid rgba(37,99,235,.35)}
.btn{cursor:pointer; user-select:none; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; padding:0 12px; height:38px; border:1px solid var(--btn-act-bd); background:var(--btn-act-bg); color:var(--btn-act-fg);}
.btn-primary{ background:var(--btn-pri-bg); color:var(--btn-pri-fg); border-color:var(--btn-pri-bd); }
.btn-secondary{ background:var(--btn-sec-bg); color:var(--btn-sec-fg); border-color:var(--btn-sec-bd); }
.btn-apply{ background:var(--btn-act-bg); color:var(--btn-act-fg); border-color:var(--btn-act-bd); }
.badge{display:inline-flex;align-items:center;justify-content:center;
  width:26px;height:38px;border:1px solid var(--border);border-left:none;border-radius:0 10px 10px 0;background:var(--card);color:var(--text)}
.coord{display:flex}
.coord input{border-right:none;border-radius:10px 0 0 10px;width:120px}
.help{font-size:11px;color:var(--muted);margin-top:6px}
#themeToggle{position:absolute;top:10px;right:12px;padding:6px 10px;border-radius:8px;border:1px solid #334155;background:var(--panel);color:var(--text);cursor:pointer;font-size:12px}

/* Explicit countdown + progress */
.countdown-wrap { margin-top: 8px }
.countdown-label { font-size: 12px; color: var(--muted) }
.countdown-large {
  font-variant-numeric: tabular-nums;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: clamp(28px, 8vw, 48px);
  font-weight: 800;
  letter-spacing: .5px;
}
.progress { height: 6px; background: var(--border); border-radius: 999px; overflow: hidden; margin-top: 8px }
.progress > .bar { height: 100%; width: 0%; background: var(--btn-pri-bg); transition: width .4s ease }

/* Mobile refinements */
@media (max-width: 780px) {
  .grid { grid-template-columns: 1fr; gap: 10px; }
  .card { padding: 12px; }
  .big { font-size: clamp(28px, 8vw, 40px); }
  #nextEventTime { font-size: clamp(24px, 7vw, 32px); }
  .row { flex-wrap: wrap; gap: 8px; }
  .row .btn { flex: 1 1 48%; justify-content: center; }
  .coord { display: grid; grid-template-columns: 1fr auto; }
  .coord input { width: 100%; }
  #themeToggle { top: 8px; right: 8px; }
}
@media (max-width: 380px) {
  input, select, button { height: 36px; }
  .badge { height: 36px; width: 24px; }
}
</style>
</head>
<body>
<header>
  <h1>‚òÄÔ∏è Sun Clock Pro ‚Äî Minimal</h1>
  <button id="themeToggle" class="btn">üåó Theme</button>
</header>

<div class="page">
  <div class="section">
    <h2>Today</h2>
    <div class="grid" style="padding:12px">
      <!-- Left -->
      <div class="card">
        <div class="kv"><div class="label">Location</div><div id="locLabel">‚Äî</div></div>
        <div class="kv"><div class="label">Timezone</div><div id="tzLabel">‚Äî</div></div>
        <div class="hr"></div>
        <div class="kv"><div class="label">Sunrise</div><div class="big" id="sunriseTime">--:--:--</div></div>
        <div class="kv" style="margin-top:8px"><div class="label">Sunset</div><div class="big" id="sunsetTime">--:--:--</div></div>
        <div class="hr"></div>
        <div class="kv"><div class="label">Day Length</div><div id="dayLength">‚Äî</div></div>
      </div>

      <!-- Center -->
      <div class="card">
        <div class="label">Now</div>
        <div class="big" id="nowClock">--:--:--</div>

        <div class="kv" style="margin-top:16px">
          <div class="label">Next Event</div>
          <div style="display:flex;align-items:baseline;gap:16px">
            <div style="font-size:28px;font-weight:800" id="nextEventLabel">‚Äî</div>
            <div class="big" id="nextEventTime" style="font-size:32px">--:--:--</div>
          </div>

          <!-- Explicit countdown + progress bar -->
          <div class="countdown-wrap" aria-live="polite">
            <div class="countdown-label" id="countdownLabel">Time to ‚Äî</div>
            <div class="countdown-large" id="countdownLarge">00:00:00</div>
            <div class="small" id="nextEventCountdown" style="margin-top:4px"></div>
            <div class="progress"><div class="bar" id="dayProgress"></div></div>
          </div>

          <!-- Date context -->
          <div class="small" id="nextEventNote" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="row">
          <button id="useGPS" class="btn btn-primary">Use My Location</button>
          <button id="useManual" class="btn btn-secondary">Use Manual Location</button>
        </div>

        <div class="kv"><div class="label">City / Label (optional)</div><input id="label" placeholder="e.g., Charlotte, NC"></div>

        <div class="kv"><div class="label">Latitude</div><div class="coord">
          <input id="lat" inputmode="decimal" placeholder="e.g., 35.2106"><div id="latHemi" class="badge btn" title="Toggle N/S">N</div>
        </div></div>

        <div class="kv"><div class="label">Longitude</div><div class="coord">
          <input id="lng" inputmode="decimal" placeholder="e.g., 80.8021"><div id="lngHemi" class="badge btn" title="Toggle E/W">W</div>
        </div><div class="help">Inputs are absolute values; hemisphere badge sets sign.</div></div>

        <div class="kv"><div class="label">Time zone</div><select id="tzMode">
          <option value="auto" selected>America/New_York (Auto)</option>
        </select></div>

        <div class="row"><button id="apply" class="btn btn-apply">Apply</button></div>
        <div class="hr"></div>
        <div class="small" id="detectInfo">Runs offline. For GPS auto-detect, use HTTPS/local file.</div>
      </div>
    </div>
  </div>
</div>

<script>
// Register service worker for PWA (works on HTTPS / GitHub Pages)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(err => {
      console.log('SW registration failed:', err);
    });
  });
}

/* ===== Theme ===== */
(function theme(){
  const root=document.documentElement, key='sunclock_theme';
  function apply(mode){
    root.dataset.theme=mode;
    if(mode==='white'){
      root.style.setProperty('--bg','#f8fafc');
      root.style.setProperty('--panel','#ffffff');
      root.style.setProperty('--card','#f1f5f9');
      root.style.setProperty('--text','#0f172a');
      root.style.setProperty('--muted','#475569');
      root.style.setProperty('--border','#cbd5e1');
      root.style.setProperty('--btn-pri-bg','#16a34a'); root.style.setProperty('--btn-pri-fg','#0f172a'); root.style.setProperty('--btn-pri-bd','#16a34a');
      root.style.setProperty('--btn-sec-bg','#d1d5db'); root.style.setProperty('--btn-sec-fg','#0f172a'); root.style.setProperty('--btn-sec-bd','#94a3b8');
      root.style.setProperty('--btn-act-bg','#e5e7eb'); root.style.setProperty('--btn-act-fg','#0f172a'); root.style.setProperty('--btn-act-bd','#cbd5e1');
    }else{
      root.style.setProperty('--bg','#0f172a');
      root.style.setProperty('--panel','#111827');
      root.style.setProperty('--card','#0b1220');
      root.style.setProperty('--text','#e5e7eb');
      root.style.setProperty('--muted','#94a3b8');
      root.style.setProperty('--border','#1f2937');
      root.style.setProperty('--btn-pri-bg','#14532d'); root.style.setProperty('--btn-pri-fg','#ffffff'); root.style.setProperty('--btn-pri-bd','#14532d');
      root.style.setProperty('--btn-sec-bg','#1e293b'); root.style.setProperty('--btn-sec-fg','#ffffff'); root.style.setProperty('--btn-sec-bd','#1e293b');
      root.style.setProperty('--btn-act-bg','#0b1220'); root.style.setProperty('--btn-act-fg','#e5e7eb'); root.style.setProperty('--btn-act-bd','#1f2937');
    }
  }
  apply(localStorage.getItem(key)||'blue');
  document.getElementById('themeToggle').onclick=()=>{
    const next=(root.dataset.theme||'blue')==='blue'?'white':'blue';
    apply(next); localStorage.setItem(key,next);
  };
})();

/* ===== Minimal SunCalc ===== */
const SunCalc=(function(){
  const PI=Math.PI, rad=PI/180;
  function toJulian(date){ return date.valueOf()/86400000 - 0.5 + 2440588; }
  function fromJulian(j){ return new Date((j + 0.5 - 2440588)*86400000); }
  function toDays(date){ return toJulian(date) - 2451545; }
  function solarMeanAnomaly(d){ return rad*(357.5291 + 0.98560028*d); }
  function eclipticLongitude(M){
    const C = rad*(1.9148*Math.sin(M) + 0.02*Math.sin(2*M) + 0.0003*Math.sin(3*M));
    const P = rad*102.9372;
    return M + C + P + PI;
  }
  const e = rad*23.4397;
  function declination(L,b=0){ return Math.asin(Math.sin(b)*Math.cos(e) + Math.cos(b)*Math.sin(e)*Math.sin(L)); }
  function julianCycle(d,lw){ return Math.round(d - 0.0009 - lw/(2*Math.PI)); }
  function approxTransit(Ht,lw,n){ return 0.0009 + (Ht + lw)/(2*Math.PI) + n; }
  function solarTransitJ(ds,M,L){ return 2451545 + ds + 0.0053*Math.sin(M) - 0.0069*Math.sin(2*L); }
  function getTimes(date, lat, lng){
    const lw = -lng*rad, phi = lat*rad;
    const d = toDays(date);
    const n = julianCycle(d, lw);
    const ds = approxTransit(0, lw, n);
    const M = solarMeanAnomaly(ds);
    const L = eclipticLongitude(M);
    const dec = declination(L);
    const Jnoon = solarTransitJ(ds, M, L);
    const h0 = -0.833*rad;
    const w = Math.acos((Math.sin(h0) - Math.sin(phi)*Math.sin(dec)) / (Math.cos(phi)*Math.cos(dec)));
    const a = approxTransit(w, lw, n);
    const Jset = solarTransitJ(a, M, L);
    const Jrise = Jnoon - (Jset - Jnoon);
    return { solarNoon: fromJulian(Jnoon), sunrise: fromJulian(Jrise), sunset: fromJulian(Jset) };
  }
  return { getTimes };
})();

/* ===== App ===== */
const $=id=>document.getElementById(id);
const LS='sunclock_coords';
let current={lat:35.2106,lng:-80.8021,label:'My Location'};
let nextTarget=null;
let nextLabelText="";
let lastTimes=null;

function hemi(v,pos,neg){ return `${Math.abs(v).toFixed(4)}¬∞ ${v>=0?pos:neg}`; }
function signedFromUI(value,hemi){ const v=Math.abs(parseFloat(value)||0); return (hemi==='S'||hemi==='W')?-v:v; }
function fmt(t){ const p=n=>String(n).padStart(2,'0'); return `${p(t.getHours())}:${p(t.getMinutes())}:${p(t.getSeconds())}`; }
function dayLen(sr,ss){ const ms=ss-sr; const h=Math.floor(ms/3600000), m=Math.round((ms%3600000)/60000); return `${h}h ${m}m`; }

function updateCountdown() {
  const large = $('countdownLarge');
  const small = $('nextEventCountdown');
  const label = $('countdownLabel');
  const bar   = $('dayProgress');

  const now = new Date();

  // Repair nextTarget if it became non-Date
  if (nextTarget && !(nextTarget instanceof Date)) {
    const t = new Date(nextTarget);
    nextTarget = isNaN(t.getTime()) ? null : t;
  }

  // If missing or stale, recompute
  if (!nextTarget || isNaN(nextTarget.getTime()) || (now - nextTarget) > 1000) {
    render(current);
  }

  if (!nextTarget || isNaN(nextTarget.getTime())) {
    large.textContent = "00:00:00";
    small.textContent = "";
    label.textContent = "";
    if (bar) bar.style.width = "0%";
    return;
  }

  const pad2 = n => String(n).padStart(2, '0');
  const fmtHMS = ms => {
    if (!isFinite(ms) || ms <= 0) return "00:00:00";
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
  };
  const fmtDuration = ms => {
    if (!isFinite(ms) || ms <= 0) return "0s";
    const s = Math.floor(ms / 1000);
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    const parts = [];
    if (d) parts.push(`${d}d`);
    if (h) parts.push(`${h}h`);
    if (m) parts.push(`${m}m`);
    if (!d && !h) parts.push(`${sec}s`);
    return parts.join(' ');
  };

  const ms = nextTarget.getTime() - now.getTime();
  large.textContent = fmtHMS(ms);
  small.textContent = ms > 0 ? ("in " + fmtDuration(ms)) : "now";
  label.textContent = `Time to ${nextLabelText}`;

  // Day progress bar
  if (lastTimes && now >= lastTimes.sunrise && now <= lastTimes.sunset) {
    const pct = Math.min(100, Math.max(0,
      ((now - lastTimes.sunrise) / (lastTimes.sunset - lastTimes.sunrise)) * 100
    ));
    if (bar) bar.style.width = pct.toFixed(1) + "%";
  } else {
    if (bar) bar.style.width = (now < (lastTimes?.sunrise || 0)) ? "0%" : "100%";
  }
}

function save(c){ localStorage.setItem(LS, JSON.stringify(c)); }
function load(){ try{ const raw=localStorage.getItem(LS); if(!raw) return null; const c=JSON.parse(raw); if(isFinite(c.lat)&&isFinite(c.lng)) return c; }catch(e){} return null; }

function coordsToUI(c){
  $('lat').value=Math.abs(c.lat).toFixed(5);
  $('lng').value=Math.abs(c.lng).toFixed(5);
  $('latHemi').textContent = c.lat>=0?'N':'S';
  $('lngHemi').textContent = c.lng>=0?'E':'W';
  $('label').value=c.label||'';
}

function uiToCoords(){
  const lat=signedFromUI($('lat').value, $('latHemi').textContent.trim());
  const lng=signedFromUI($('lng').value, $('lngHemi').textContent.trim());
  const label=$('label').value.trim()||'My Location';
  return {lat,lng,label};
}

function render(c){
  const now = new Date();
  const times = SunCalc.getTimes(now, c.lat, c.lng);

  $('locLabel').textContent = c.label || `${hemi(c.lat,'N','S')}, ${hemi(c.lng,'E','W')}`;
  $('tzLabel').textContent  = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
  $('sunriseTime').textContent = fmt(times.sunrise);
  $('sunsetTime').textContent  = fmt(times.sunset);
  $('dayLength').textContent   = dayLen(times.sunrise, times.sunset);

  let nextLabel, nextWhen, noteDate;
  if (now < times.sunrise){ nextLabel='Sunrise'; nextWhen=times.sunrise; noteDate=now; }
  else if (now < times.sunset){ nextLabel='Sunset'; nextWhen=times.sunset; noteDate=now; }
  else { const tmr = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
         const tTimes = SunCalc.getTimes(tmr, c.lat, c.lng);
         nextLabel='Sunrise'; nextWhen=tTimes.sunrise; noteDate=tmr; }

  $('nextEventLabel').textContent = nextLabel;
  $('nextEventTime').textContent  = fmt(nextWhen);
  $('nextEventNote').textContent  = `at ${fmt(nextWhen)} (${noteDate.getMonth()+1}/${noteDate.getDate()}/${noteDate.getFullYear()})`;

  nextTarget    = nextWhen;
  nextLabelText = nextLabel;
  lastTimes     = times;
}

function tick(){
  const now = new Date();
  $('nowClock').textContent = fmt(now);
  // If target missing/invalid/or passed, recompute next event
  if (!nextTarget || isNaN(nextTarget.getTime()) || (now - nextTarget) > 1000) {
    render(current);
  }
  updateCountdown();
  requestAnimationFrame(()=>setTimeout(tick,250));
}

document.addEventListener('DOMContentLoaded', () => {
  const saved = load(); if(saved) current=saved;
  coordsToUI(current);
  render(current);
  tick();

  $('latHemi').onclick = ()=>{ $('latHemi').textContent = ($('latHemi').textContent==='N'?'S':'N'); };
  $('lngHemi').onclick = ()=>{ $('lngHemi').textContent = ($('lngHemi').textContent==='E'?'W':'E'); };
  $('apply').onclick = ()=>{ current=uiToCoords(); save(current); render(current); };
  $('useManual').onclick = ()=>{ current=uiToCoords(); save(current); render(current); };
  $('useGPS').onclick = ()=>{
    if(!navigator.geolocation){ $('detectInfo').textContent='Geolocation not available.'; return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      current={lat:pos.coords.latitude,lng:pos.coords.longitude,label:'My Location'};
      coordsToUI(current); save(current); render(current);
      $('detectInfo').textContent=`Detected: lat ${current.lat.toFixed(5)}, lng ${current.lng.toFixed(5)} (¬±${Math.round(pos.coords.accuracy)} m)`;
    }, err=>{ $('detectInfo').textContent='Geolocation error: '+err.message; },
    {enableHighAccuracy:true,timeout:10000,maximumAge:0});
  };
});
</script>
</body>
</html>
